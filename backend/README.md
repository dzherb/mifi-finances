# Finances Manager API

___
## Запуск проекта

- Предварительно создаем в каталоге `backend` файл `.env` по примеру `.env.template`. Там же задается строка для подключения к PostgreSQL. Его можно поднять любым удобным образом, например, в отдельном контейнере с открытым портом.
- Убеждаемся, что в системе стоит пакетный менеджер [uv](https://docs.astral.sh/uv/).
- Все дальнейшие шаги выполняем из каталога `backend`

### Запуск с помощью `make`
- Если у вас стоит утилита `make` (по-умолчанию идет с Linux и MacOS), то для установки зависимостей, миграции БД и запуска сервера достаточно выполнить:
   ```bash  
   make runserver
   ```

### Ручной запуск
- `uv` сам позаботится о нужной версии Python, достаточно выполнить следующую команду, находясь в каталоге `backend`:
    ```bash
    uv sync --all-groups
    ```
- Применяем миграции (см. ниже отдельный раздел про миграции)
- Запускаем dev-сервер, по умолчанию на порте 8000:
   ```bash
   uv run uvicorn main:app --reload
   ```
   Если все прошло ок, то будет доступен адрес http://127.0.0.1:8000/docs
___
## Используемые в разработке инструменты

### Линтеры

Линтеры помогают держать кодовую базу в едином стиле и избегать глупых ошибок. [Ruff](https://docs.astral.sh/ruff/) не только следит за применением PEP 8 и другими best practices, но еще и умеет форматировать исходный код, причем делает это очень быстро.

#### Применить линтеры

```bash
make lint
```
Или
```bash
ruff check --fix .
```
Команда выше выведет все проблемные места и применит фиксы там, где это можно сделать автоматически. Список актуальных правил для проверки лежит в `ruff.toml`

#### Отформатировать код
```bash
ruff format .
```
Или
```bash
make fmt
```
### Type checking 

Одних линтеров может быть недостаточно чтобы выловить все возможные баги еще до запуска кода. Тут на помощь приходит [mypy](https://mypy.readthedocs.io/en/stable/index.html), статический type cheker для Python. Можно сказать, что он решает ту же проблему, что и TypeScript по отношению к JavaScript, но использует уже существующий в языке механизм аннотаций.

#### Проверить типизацию
```bash
mypy .
```
Или
```bash
make type-check
```

#### Применить сразу все проверки
```bash
make full-check
```


### Миграции

С помощью миграций мы можем версионировать состояние базы данных. Например, после добавления в коде новой модели или изменения полей у существующей. 

В проекте для этой цели используется [Alembic](https://alembic.sqlalchemy.org/en/latest/index.html).

#### Создать новую миграцию
```bash
# Скрипт автоматически запросит название ревизии
make migrations
```
Или
```bash
alembic revision --autogenerate -m "revision message"
```

**Важно!** Автогенерация не всегда делает что мы ожидаем, хорошим тоном будет пройтись по созданному файлу и убедиться, что в нем все корректно. 

Сообщение к миграции лучше оставлять короткими и по делу. Например:
- "add name field"
- "delete users table"

и т.п.

Также стоит следить за тем, чтобы миграции были компактными. Не очень хорошо, когда в одной ревизии добавляем сразу три таблицы и обновляем или удаляем с десяток полей. Тут похожая история как с коммитами.
#### Применить актуальную миграцию
```bash
make migrate
```
Или
```bash
alembic upgrade head
```

Эту же команду можно запускать и на пустой БД. Alembic применит все необходимые миграции от текущего состояния БД до актуальной версии. 

Если выполнять через `make`, то скрипт также актуализирует схему БД в `README.md`.

### Тесты

Для тестирования используется фреймворк [Pytest](https://docs.pytest.org/en/stable/index.html). 

В текущей конфигурации каждый тест, которому нужен доступ к базе данных, будет зависеть от отдельно созданной БД (с примененными миграциями). Так мы гарантируем идемпотентность, тесты не влияют друг на друга и не взаимодействуют с общими данными. 


#### Запуск тестов
```bash
pytest
```

#### Запуск тестов параллельно
```bash
make test
```
Или
```bash
pytest -n auto
```

Если нужно ускорить общее выполнение тестов, можно воспользоваться любой из команд выше. Так тесты будут случайно распределены между доступными CPU.

#### Покрытие кода тестами

```bash
make coverage
```

Команда прогонит тесты и откроет страницу в браузере, где можно посмотреть детальный отчет по покрытию. 

### Наполнение БД тестовыми данными

```bash
make seed
```
Или
```bash
# Убедитесь сперва, что миграции применены
uv run scripts/seed.py
```
#### *Дополнительно: очистка базы данных*

```bash
make flush
```
Или
```bash
# Убедитесь сперва, что миграции применены
uv run scripts/seed.py --clear
```